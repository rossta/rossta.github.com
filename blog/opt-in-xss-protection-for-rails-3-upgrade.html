<!doctype html>
<html class="antialiased" lang="en">
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<title>Opt-in XSS protection for Rails 3 upgrade - rossta.net</title>
<meta name="description" content="A useful technique for upgrading ERB templates in Rails 3" />
<meta name="keywords" content="Ruby" />
<meta itemprop="name" content="Opt-in XSS protection for Rails 3 upgrade" />
<meta itemprop="description" content="A useful technique for upgrading ERB templates in Rails 3" />
<meta itemprop="image" content="https://rossta.net/assets/images/blog/stock/logs-pexels-photo.jpg" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="rossta.net" />
<meta name="twitter:url" content="https://rossta.net/blog/opt-in-xss-protection-for-rails-3-upgrade.html" />
<meta name="twitter:title" content="Opt-in XSS protection for Rails 3 upgrade" />
<meta name="twitter:description" content="A useful technique for upgrading ERB templates in Rails 3" />
<meta name="twitter:image" content="https://rossta.net/assets/images/blog/stock/logs-pexels-photo.jpg" />
<meta property="og:url" content="https://rossta.net/blog/opt-in-xss-protection-for-rails-3-upgrade.html" />
<meta property="og:type" content="website" />
<meta property="og:title" content="Opt-in XSS protection for Rails 3 upgrade" />
<meta property="og:image" content="https://rossta.net/assets/images/blog/stock/logs-pexels-photo.jpg" />
<meta property="og:description" content="A useful technique for upgrading ERB templates in Rails 3" />
<meta property="og:site_name" content="rossta.net" />
<meta property="og:locale" content="en_US" />
<link rel="separator" href="-" />
    <meta charset="utf-8" />
    <meta http-equiv='X-UA-Compatible' content='IE=edge;chrome=1' />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="mobile-web-app-capable" content="yes">

    <link rel="pingback" href="https://webmention.io/rossta.net/xmlrpc" />
    <link rel="webmention" href="https://webmention.io/rossta.net/webmention" />
    <link rel="canonical" href="https://rossta.net/blog/opt-in-xss-protection-for-rails-3-upgrade.html" />
    <script type="application/ld+json">
      {"@context":"https://schema.org","@type":"Article","publisher":{"@type":"Organization","name":"Ross Kaffenberger"},"author":{"@type":"Person","name":"Ross Kaffenberger","image":{"@type":"ImageObject","url":"https://rossta.net/assets/images/me.jpg","width":400,"height":400},"url":"https://rossta.net","sameAs":["https://rossta.net/about/","https://twitter.com/rossta"]},"headline":"Opt-in XSS protection for Rails 3 upgrade","url":{"scheme":"https","user":null,"password":null,"host":"rossta.net","port":null,"path":"/blog/opt-in-xss-protection-for-rails-3-upgrade.html","query":null,"fragment":null},"datePublished":"2011-02-26T00:00:00Z","keywords":"ruby","description":"A useful technique for upgrading ERB templates in Rails 3","mainEntityOfPage":{"@type":"WebPage","@id":"https://rossta.net"}}
    </script>


    <link rel="stylesheet" href="/css/app.0c5bc665ae532bceffde.css" media="all"></link>
    <script async defer data-domain="rossta.net" src="https://plausible.io/js/plausible.outbound-links.js"></script>
  </head>
  <body id="application" class="leading-relaxed">
    <header id="welcome-nav" class="top-bar text-gray-800 sm:flex sm:justify-between sm:items-center sm:px-4 sm:py-3" data-topbar>
  <div class="flex justify-between items-center px-4 py-3 sm:p-0">
    <h1 class="text-2xl font-bold">
      <a class="logo" href="/"><span>rossta.net</span></a>
    </h1>
    <button type="button" aria-label="Menu" class="top-bar-menu-button sm:hidden block text-gray-500 hover:text-gray-700 focus:text-gray-700 focus:outline-none">
      <svg class="h-6 w-6 fill-current" viewBox="0 0 24 24">
        <path class="icon" d="M4 5h16a1 1 0 0 1 0 2H4a1 1 0 1 1 0-2zm0 6h16a1 1 0 0 1 0 2H4a1 1 0 0 1 0-2zm0 6h16a1 1 0 0 1 0 2H4a1 1 0 0 1 0-2z"/>
        <path class="icon hidden" d="M18.278 16.864a1 1 0 0 1-1.414 1.414l-4.829-4.828-4.828 4.828a1 1 0 0 1-1.414-1.414l4.828-4.829-4.828-4.828a1 1 0 0 1 1.414-1.414l4.829 4.828 4.828-4.828a1 1 0 1 1 1.414 1.414l-4.828 4.829 4.828 4.828z"/>
      </svg>
    </button>
  </div>
  <nav class="top-bar-section hidden sm:block sm:flex sm:justify-around px-2 pt-2 pb-4">
    <a class="block px-2 py-1 hover:bg-green-200 sm:mt-0 sm:ml-2 mt-1" href="/blog/">archive</a>
    <a class="block px-2 py-1 hover:bg-green-200 sm:mt-0 sm:ml-2 mt-1" href="/about/">about</a>
    <a class="block px-2 py-1 hover:bg-green-200 sm:mt-0 sm:ml-2 mt-1" href="/feed.xml">feed</a>
  </nav>
</header>

    <main id="main" role="main" class="layout container">
        <article class="post mb-12">
    <header class="page-header mt-4">
  <h1>
    Opt-in XSS protection for Rails 3 upgrade
  </h1>
    <h2 class="mt-4 text-gray-600 font-medium">
      A useful technique for upgrading ERB templates in Rails 3
    </h2>
</header>

    <p>When I’m really hungry, all I want is a Chipotle burrito. It seems like a good idea – it’s big, it tastes good and it’s right there across the street! It’s not long before I regret taking on that much food in one sitting. So it goes for upgrading <a href="http://www.weplay.com" target="_blank" rel="noopener noreferrer">Weplay</a> to Rails 3.</p>

<p>A fundamental shift in Rails 3 is html escaping by default. A number of posts describe the need for this change, an important tool against cross-site scripting (XSS) attacks. Rather than rely on developers to escape user content where needed, all strings that don’t originate from Rails (link_to, form_for, etc.) are treated as unsafe. This is a good thing. Unfortunately, for most running Rails 2 apps, automatically html-escaping our views without adjustments results in a hot steaming pile of onscreen view-source dung.</p>

<p>This is exactly what you see the first time you install the recommended <a href="https://github.com/rails/rails_xss" target="_blank" rel="noopener noreferrer">rails_xss</a> plugin to provide Rails 3 XSS protection for your Rails 2 app. Despite the obvious work entailed to get things back to normal, this is another good thing. Making the switch to Rails 3 overnight may not be feasible, but adding XSS protection ahead of time will help smooth the transition.</p>

<p>Except perhaps when your app is large. At the present count, we have over 1500 *.html.erb files in Weplay’s main repo. We simply can’t afford to devote the days to focus solely on fixes for excess html escaping in our templates. We need to be able to iterate on this change like everything else; incrementally instead of as an overhaul.</p>

<p>We came up with an alternative: <a href="https://github.com/weplay/rails_xss" target="_blank" rel="noopener noreferrer">we forked rails_xss</a> to <em>disable</em> automatic html escaping by default while still providing the use of “html safe” strings and the Erubis ERB template engine. Developers can turn on html escaping locally using the <strong>autoescape</strong> block helper.</p>

<p>Everything within the helper is escaped. Anything outside the helper is not escaped. Nesting autoescapes is ok: everything inside the outermost invocation is escaped.</p>

<p>The autoescape helper allows us to apply the fixes on a view-by-view basis. We can devote most of our time to building features to help us make money and chip away at templates and partials as they pop up in our workflow. We even have a script to tell us how many files we still need to address.</p>

<p>The key to this change is manipulating the original rails_xss plugin behavior. Rails 3 helpers are composed of the String subclass <a href="http://yehudakatz.com/2010/02/01/safebuffers-and-rails-3-0/" target="_blank" rel="noopener noreferrer">SafeBuffer</a>, which will escape concatenated content not already marked as “html safe”. Internally, calling .html_safe on a string simply sets a flag on the string object and this is flag is checked when adding to a string to SafeBuffer. By monkey-patching String, we disable the automatic escaping by always returning true for the html_safe? check. The autoescape flips on the flag, yields to the content block and flips the flag check back off afterwards. When autoescaping is already turned on, the block is returned as-is to allow nested autoescaping.</p>

<p>There are alternatives. We could all crash on the upgrade (no time!) or we could keep the fully “escaped” version of our app in a separate branch, chip away at it, merge occasionally (not fun!).</p>

<p>The opt-in approach works well for our agile mindset of fast incremental improvement and frequent deployment. I recommend using our fork if you have similar needs. It may even help with the heartburn.</p>

<p>Resources</p>

<ul>
<li><a href="https://github.com/rails/rails_xss" target="_blank" rel="noopener noreferrer">rails/rails_xss</a></li>
<li><a href="https://github.com/weplay/rails_xss" target="_blank" rel="noopener noreferrer">weplay/rails_xss</a></li>
<li><a href="http://yehudakatz.com/2010/02/01/safebuffers-and-rails-3-0/" target="_blank" rel="noopener noreferrer">Safe Buffer</a></li>
</ul>

  </article>
  <section class="mb-12">
    <p class="text-right">
      <a href="https://twitter.com/intent/tweet?text=Opt-in%20XSS%20protection%20for%20Rails%203%20upgrade%20-%20rossta.net&amp;url=https%3A%2F%2Frossta.net%2Fblog%2Fopt-in-xss-protection-for-rails-3-upgrade.html" class="font-bold" target="_blank" rel="noopener noreferrer">Discuss it on Twitter</a>
      &middot;
      <span class="italic font-light">
        Published on Feb 26, 2011
      </span>
    </p>
  </section>
  <section class="signup-form-standalone hero">
    <script src="https://f.convertkit.com/ckjs/ck.5.js" async></script>
<form
  action="https://app.convertkit.com/forms/818387/subscriptions?ref=Ruby"
  class="seva-form formkit-form"
  method="post"
  data-sv-form="818387"
  data-uid="cda82aafbf"
  data-format="inline"
  data-version="5"
  data-options="{&quot;settings&quot;:{&quot;after_subscribe&quot;:{&quot;action&quot;:&quot;message&quot;,&quot;success_message&quot;:&quot;Success! Now check your email to confirm your subscription.&quot;,&quot;redirect_url&quot;:&quot;&quot;},&quot;modal&quot;:{&quot;trigger&quot;:&quot;timer&quot;,&quot;scroll_percentage&quot;:null,&quot;timer&quot;:&quot;300&quot;,&quot;devices&quot;:null,&quot;show_once_every&quot;:&quot;7&quot;},&quot;recaptcha&quot;:{&quot;enabled&quot;:false},&quot;return_visitor&quot;:{&quot;action&quot;:&quot;show&quot;,&quot;custom_content&quot;:&quot;&quot;},&quot;slide_in&quot;:{&quot;display_in&quot;:null,&quot;trigger&quot;:null,&quot;scroll_percentage&quot;:null,&quot;timer&quot;:null,&quot;devices&quot;:null,&quot;show_once_every&quot;:null}}}"
>
  <div>
    <div class="mb-4">
      <h3 class="mb-2">
  Join the Newsletter
</h3>
<p>
  Subscribe to get an occasional email about web development and Rails. Thank you!
</p>

    </div>
    <ul class="formkit-alert formkit-alert-error" data-element="errors" data-group="alert"></ul>
    <div data-element="fields" data-stacked="false" class="seva-fields formkit-fields">
      <div class="formkit-field">
        <label for="email_address" class="sr-only">Email address</label>
        <input
          class="formkit-input"
          id="email_address"
          name="email_address"
          placeholder="Your email address"
          required=""
          type="email"
          style="border-color: rgb(227, 227, 227); border-radius: 4px; color: rgb(0, 0, 0); font-weight: 400;"
        />
      </div>
      <button
        data-element="submit"
        class="formkit-submit button button-green"
      >
        <div class="formkit-spinner">
          <div></div>
          <div></div>
          <div></div>
        </div>
        <span>Subscribe</span>
      </button>
    </div>
  </div>
  <style>
  </style>
    <input type="hidden" name="tags[]" value="733960" />
  <input type="hidden" aria-label="URL" name="fields[url]" placeholder="URL" value="https://rossta.net/blog/opt-in-xss-protection-for-rails-3-upgrade.html" />
</form>


  </section>
  <section class="index-posts mb-24">
    <h2 class="mb-8">More posts</h2>
      <article class="index-post">
    <header class="index-title">
      <a href="/blog/when-your-fat-models-need-to-go-on-a-diet-part-2.html">When Your Fat Models Need to Go on a Diet, Part 2</a>
    </header>
      <p>More thoughts on refactoring large model classes in Rails</p>
  </article>
  <article class="index-post">
    <header class="index-title">
      <a href="/blog/when-your-fat-models-need-to-go-on-a-diet.html">When Your Fat Models Need to Go on a Diet</a>
    </header>
      <p>Thoughts on refactoring large model classes in Rails</p>
  </article>
  <article class="index-post">
    <header class="index-title">
      <a href="/blog/behavior-driven-event-driven-eventmachine-rspec.html">How to Test Your Eventmachine Code with RSpec</a>
    </header>
      <p>Test an eventmachine server-client socket connection with rspec</p>
  </article>

  </section>
  <article class="mb-24">
      <figure>
        <img src="/assets/images/blog/stock/logs-pexels-photo.jpg" loading="lazy" alt="" />
      </figure>
  </article>

    </main>
    <footer class="bg-silver text-xs">
  <div class="layout container p-6">
    <img src="/assets/images/turtle-logo.svg" loading="lazy" class="turtle w-8 mb-6" alt="" />
    <section class="lg:flex lg:justify-between">
      <section class="mb-8">
        <h5 class="font-bold mb-4">Most Popular</h5>
        <ul>
            <li class="mb-1"><a href="/blog/why-does-rails-install-both-webpacker-and-sprockets.html">Why does Rails 6 include both Webpacker and Sprockets?</a></li>
            <li class="mb-1"><a href="/blog/reasons-to-switch-to-webpacker.html">25 reasons to switch to Webpack(er)</a></li>
            <li class="mb-1"><a href="/blog/webpacker-with-bootstrap.html">Using Bootstrap with Rails Webpacker</a></li>
            <li class="mb-1"><a href="/blog/importing-images-with-webpacker.html">Importing images with Webpacker</a></li>
            <li class="mb-1"><a href="/blog/from-sprockets-to-webpack.html">How we switched from Sprockets to Webpacker</a></li>
        </ul>
      </section>
      <section class="mb-8">
        <h5 class="font-bold mb-4">
          <a class="text-gray-900 hover:text-gray-700" href="blog/tags.html">
            Categories
          </a>
        </h5>
        <ul>
            <li class="mb-1"><a href="/blog/tags/rails.html">Rails</a></li>
            <li class="mb-1"><a href="/blog/tags/ruby.html">Ruby</a></li>
            <li class="mb-1"><a href="/blog/tags/javascript.html">JavaScript</a></li>
        </ul>
      </section>
      <section class="mb-8">
        <h5 class="font-bold mb-4">Contact</h5>
        <ul>
          <li class="mb-1"><a target="_blank" href="mailto:ross@rossta.net" rel="me noopener nofollow">email</a></li>
          <li class="mb-1"><a target="_blank" href="https://twitter.com/rossta" rel="me noopener nofollow">twitter</a></li>
          <li class="mb-1"><a target="_blank" href="https://github.com/rossta" rel="me noopener nofollow">github</a></li>
          <li class="mb-1"><a target="_blank" href="https://www.linkedin.com/in/rosskaffenberger" rel="me noopener nofollow">linkedin</a></li>
          <li class="mb-1"><a target="_blank" href="https://stackoverflow.com/users/771838/rossta?tab=profile" rel="me noopener nofollow">stackoverflow</a></li>
        </ul>
      </section>
    </section>
    <p class="copyright text-center text-xs font-light">
      © 2023 Ross Kaffenberger. All rights reserved.
    </p>
  </div>
</footer>

    <script src="/js/runtime.ab3e4b5316b2997723cc.js"></script>"<script src="/js/app.d1ef27c9a26cf7bc4240.js"></script>"
    
  </body>
</html>
