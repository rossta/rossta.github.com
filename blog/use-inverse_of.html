<!doctype html>
<html>
  <head>
    <title>Use inverse_of - rossta.net</title>
<meta name="description" content="ActiveRecord will try hard to infer the inverse relation for your associations, but you may benefit from setting the inverse_of option wherever possible" />
<meta name="keywords" content="Rails, Code, Ruby" />
<meta name="site" content="rossta.net" />
<meta property="og:site_name" content="rossta.net" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:creator" content="Ross Kaffenberger" />
<meta name="twitter:description" content="ActiveRecord will try hard to infer the inverse relation for your associations, but you may benefit from setting the inverse_of option wherever possible" />
<meta name="twitter:image:src" content="https://rossta.net/assets/images/blog/stock/fall-leaves-pexels-photo.jpg" />
<meta name="twitter:title" content="Use inverse_of" />
<meta property="og:description" content="ActiveRecord will try hard to infer the inverse relation for your associations, but you may benefit from setting the inverse_of option wherever possible" />
<meta property="og:image" content="https://rossta.net/assets/images/blog/stock/fall-leaves-pexels-photo.jpg" />
<meta property="og:title" content="Use inverse_of" />
    <meta charset="utf-8" />
    <meta http-equiv='X-UA-Compatible' content='IE=edge;chrome=1' />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <script type="text/javascript" src="//use.typekit.net/ned0mml.js"></script>
    <script type="text/javascript">try{Typekit.load();}catch(e){}</script>
    <link href="/assets/stylesheets/index.bundle-4e801f2e.css" rel="stylesheet" />
    <script src="/assets/javascripts/head.bundle-ae1a9d85.js"></script>
    <link href="/assets/images/favicon.ico" rel="icon" type="image/ico" />
  </head>
  <body id="application" class="typekit">
    <nav id="welcome-nav" class="top-bar" data-topbar>
  <ul class="title-area">
    <li class="name">
      <h1><a class="logo" href="/">rossta.net</a></h1>
    </li>
    <li class="toggle-topbar menu-icon"><a href="#">Menu</a></li>
  </ul>

  <section class="top-bar-section">
    <ul class="left">
      <li class="nav"><a href="/blog">blog</a></li>
      <li class="nav"><a href="/talks">talks</a></li>
      <li class="nav"><a href="/projects">projects</a></li>
      <li class="nav"><a href="/about">about</a></li>
      <li class="nav"><a href="/feed.xml">feed</a></li>
    </ul>
  </section>
</nav>

    <div class="row">
      <section id="main" role="main" class="large-12 small-12 columns">
          <section id="blog" class="margin-bottom double">
    <article class="post margin-bottom double">
      <header class="page-header with-summary">
  <h2>
    Use inverse_of
  </h2>
    <h3>
      Skip the Rails magic and set the :inverse_of option on your ActiveRecord associations
    </h3>
</header>

        <p><img src="https://rossta.net/assets/images/blog/stock/fall-leaves-pexels-photo.jpg" /></p>

      <p>Let&rsquo;s talk about <code>:inverse_of</code>.</p>

<p>We know Rails has ActiveRecord and ActiveRecord gives us associations and associations can really simplify our interactions with databases. These associations provide a number of configuration options, one of which is to set the &ldquo;inverse of&rdquo; your current relation.</p>

<p>This option name can be a little confusing at first so let&rsquo;s use an example. Let&rsquo;s say we have an
<code>Author</code> class and it <code>has_many :posts</code>. This means we should have a <code>Post</code> class that maintains a
column, <code>:author_id</code>, so it we can say it <code>belongs_to :author</code>.</p>

<pre><code class="ruby"># app/models/author.rb
class Author &lt; ActiveRecord::Base
  has_many :posts
end

# app/models/post.rb
class Post &lt; ActiveRecord::Base
  belongs_to :author
end
</code></pre>

<p>Ok, so we know this means if we have an author, we can ask for her posts.</p>

<pre><code class="ruby"># Loading development environment (Rails 4.2.5)
author = Author.find(1)
#  Author Load (0.3ms)  SELECT  &quot;authors&quot;.* FROM &quot;authors&quot; WHERE &quot;authors&quot;.&quot;id&quot; = $1 LIMIT 1  [[&quot;id&quot;, 1]]
#=&gt; #&lt;Author:0x007fde81898868 id: 1, ... &gt;

author.posts
#  Post Load (0.4ms)  SELECT &quot;posts&quot;.* FROM &quot;posts&quot; WHERE &quot;posts&quot;.&quot;author_id&quot; = $1  [[&quot;author_id&quot;, 1]]
#=&gt; [#&lt;Post:0x007fde810cb4a0 id: 1, ... &gt;, #&lt;Post:0x007fde810cb248 id: 2, ... &gt;, ... ]
</code></pre>

<p>We can also query for a post and ask for its author.</p>

<pre><code class="ruby">post = Post.find(1)
#  Post Load (0.3ms)  SELECT  &quot;posts&quot;.* FROM &quot;posts&quot; WHERE &quot;posts&quot;.&quot;id&quot; = $1 LIMIT 1  [[&quot;id&quot;, 1]]
#=&gt; #&lt;Post:0x007fde81c7d730 id: 1, ... &gt;

post.author
#  Author Load (0.3ms)  SELECT  &quot;authors&quot;.* FROM &quot;authors&quot; WHERE &quot;authors&quot;.&quot;id&quot; = $1 LIMIT 1  [[&quot;id&quot;, 1]]
#=&gt; #&lt;Author:0x007fde7a5c8518 id: 1, ... &gt;
</code></pre>

<h3>What It&rsquo;s For</h3>

<p>Now, for most of our associations, Rails helps us find the <strong>inverse</strong> relation. For example, if we
start with an author, then ask for her posts, each post will &ldquo;know&rdquo; that the inverse instance of this
relationship is the author. If we iterate over each of <code>author.posts</code> and ask each post for its
author, we expect to get the same author record:</p>

<pre><code class="ruby">author.posts.map { |post| post.author }
# =&gt; [#&lt;Author:0x007fde81898868 id: 1, ... &gt;, #&lt;Author:0x007fde81898868 id: 1, ... &gt;, ...]
</code></pre>

<p>For consistency, we want each post&rsquo;s author not only to be the same record, but the same
<strong>instance</strong> in memory. If I modify one author&rsquo;s attributes, I expect that change to be reflected no
matter with inverse I&rsquo;m working with. Let&rsquo;s confirm by inspecting the <code>:object_id</code>:</p>

<pre><code class="ruby">author.object_id
# =&gt; 70296816370740

object_ids = [author.object_id] + author.posts.map { |post| post.author.object_id }
# =&gt; [70296816370740, 70296816370740, 70296816370740, ... ]

object_ids.uniq.size == 1
# =&gt; true
</code></pre>

<p>Great!, This means we can say that, for the <code>Author</code> class, <code>:author</code> is the &ldquo;inverse of&rdquo; the
<code>has_many :posts</code> association. So we could add the <code>:inverse_of</code> option to specify the name of the
inverse association to ensure our object instances match up.</p>

<pre><code class="ruby"># app/models/author.rb
class Author &lt; ActiveRecord::Base
  has_many :posts, inverse_of: :author
end

# app/models/post.rb
class Post &lt; ActiveRecord::Base
  belongs_to :author, inverse_of: :post
end
</code></pre>

<p>For this example, providing this option will not change the behavior because Rails is already
setting the correct inverse instances as we might expect.</p>

<p>It may seem obvious, but Rails has to do some work to set the inverse instance on records in an association and must infer the object based on the class name and association name.</p>

<p>So it should <strong>just workâ„¢</strong>!</p>

<h3>It Doesn&rsquo;t Always Work</h3>

<p>I noticed something odd the other day.</p>

<p>I was reviewing code for our Rails app which introduced abstraction to render a list of items given by a <code>has_many</code> association. The code was passing around the inverse instance (the original owner of the association) all over the place.</p>

<p>Wouldn&rsquo;t we expect the inverse to be available on our <code>has_many</code> items?</p>

<p>Let&rsquo;s look at an oversimplified example of what we were dealing with. Building on our <code>Author</code> and <code>Post</code> from earlier, we&rsquo;ll add a <code>Tweet</code> class. Using ActiveRecord&rsquo;s single-table inheritance mechanism, <code>Tweet</code> inherits functionality from <code>Post</code>.</p>

<pre><code class="ruby"># app/models/author.rb
class Author &lt; ActiveRecord::Base
  has_many :posts
  has_many :tweets, class_name: &#39;Tweet&#39;
end

# app/models/post.rb
class Post &lt; ActiveRecord::Base
  belongs_to :author
end

# app/models/tweet.rb
class Tweet &lt; Post
  validates :text, length: { maximum: 140 }
end
</code></pre>

<p>The <code>Author</code> class <code>has_many :tweets</code> and each tweet has an author since it inherits its associations from <code>Post</code>.</p>

<pre><code class="ruby">tweet = Tweet.last
#=&gt; #&lt;Tweet:0x007fc24c1dadd8 id: 10, ... &gt;

tweet.author
#=&gt; #&lt;Author:0x007fc248e11998# id: 1, ... &gt;
</code></pre>

<p>The code was rendering each tweet in a list and each tweet needed to refer back to the author for additional data.</p>

<pre><code class="ruby">author = Author.find(1)
# Author Load (0.2ms)  SELECT  &quot;authors&quot;.* FROM &quot;authors&quot; WHERE &quot;authors&quot;.&quot;id&quot; = $1 LIMIT 1  [[&quot;id&quot;, 1]]
#=&gt; #&lt;Author:0x007fc24dee1ad0 ...&gt;

author.tweets.map { |tw| author.twitter_handle }
# Tweet Load (0.3ms)  SELECT &quot;posts&quot;.* FROM &quot;posts&quot; WHERE &quot;posts&quot;.&quot;type&quot; IN (&#39;Tweet&#39;) AND &quot;posts&quot;.&quot;author_id&quot; = $1  [[&quot;author_id&quot;, 1]]
#=&gt; [&#39;vicenta&#39;, &#39;vicenta&#39;, ... ]
</code></pre>

<p>It seemed odd to pass the author author around.</p>

<p>Each <code>tweet</code> defines its <code>author</code> association since it inherits from <code>Post</code>. I knew my colleague would have had a good reason for passing the <code>author</code> instance along so I opened up a <code>rails console</code> to find out what happened if I used the inverse association instead:</p>

<pre><code class="ruby">author = Author.find(1)
# Author Load (0.2ms)  SELECT  &quot;authors&quot;.* FROM &quot;authors&quot; WHERE &quot;authors&quot;.&quot;id&quot; = $1 LIMIT 1  [[&quot;id&quot;, 1]]
#=&gt; #&lt;Author:0x007fc24dee1ad0 ...&gt;

author.tweets.map { |tw| tw.author.twitter_handle }
# Tweet Load (0.3ms)  SELECT &quot;posts&quot;.* FROM &quot;posts&quot; WHERE &quot;posts&quot;.&quot;type&quot; IN (&#39;Tweet&#39;) AND &quot;posts&quot;.&quot;author_id&quot; = $1  [[&quot;author_id&quot;, 1]]
# Author Load (0.1ms)  SELECT  &quot;authors&quot;.* FROM &quot;authors&quot; WHERE &quot;authors&quot;.&quot;id&quot; = $1 LIMIT 1  [[&quot;id&quot;, 1]]
# Author Load (0.1ms)  SELECT  &quot;authors&quot;.* FROM &quot;authors&quot; WHERE &quot;authors&quot;.&quot;id&quot; = $1 LIMIT 1  [[&quot;id&quot;, 1]]
# Author Load (0.1ms)  SELECT  &quot;authors&quot;.* FROM &quot;authors&quot; WHERE &quot;authors&quot;.&quot;id&quot; = $1 LIMIT 1  [[&quot;id&quot;, 1]]
# Author Load (0.1ms)  SELECT  &quot;authors&quot;.* FROM &quot;authors&quot; WHERE &quot;authors&quot;.&quot;id&quot; = $1 LIMIT 1  [[&quot;id&quot;, 1]]
# Author Load (0.1ms)  SELECT  &quot;authors&quot;.* FROM &quot;authors&quot; WHERE &quot;authors&quot;.&quot;id&quot; = $1 LIMIT 1  [[&quot;id&quot;, 1]]
# Author Load (0.1ms)  SELECT  &quot;authors&quot;.* FROM &quot;authors&quot; WHERE &quot;authors&quot;.&quot;id&quot; = $1 LIMIT 1  [[&quot;id&quot;, 1]]
# Author Load (0.1ms)  SELECT  &quot;authors&quot;.* FROM &quot;authors&quot; WHERE &quot;authors&quot;.&quot;id&quot; = $1 LIMIT 1  [[&quot;id&quot;, 1]]
# ...
#=&gt; [&#39;vicenta&#39;, &#39;vicenta&#39;, ... ]
</code></pre>

<p>That&rsquo;s a lot of database queries for one author!</p>

<p>It&rsquo;s the classic problem with <code>has_many</code> associations: the &ldquo;N+1&rdquo; query. After the initial <code>author.tweet</code> query, &ldquo;N&rdquo; additional queries are needed to call each <code>tweet.author</code> back through the <code>belongs_to</code> association. We were avoiding the extra lookups by passing around the original author instance.</p>

<p>This is unfortunate because we, as we have seen, it should be possible to avoid these extra queries so that each tweet&rsquo;s author points to the same author object in memory.</p>

<p>Not only do we want to avoid the extra queries, but if modifications are made in one place, we&rsquo;d like them to be reflected elsewhere. I want to avoid something like this:</p>

<pre><code class="ruby">tweet_1 = author.tweets.first
tweet_2 = author.tweets.second

tweet_1.author.name # =&gt; &quot;Cecily&quot;
tweet_2.author.name # =&gt; &quot;Cecily&quot;

tweet_1.author.name = &quot;Martha&quot;

tweet_1.author.name # =&gt; &quot;Martha&quot;
tweet_2.author.name # =&gt; &quot;Cecily&quot;
</code></pre>

<p>So passing the <code>author</code> instance variable into the block, as an additional argument to method calls, or down to a view template is one workaround. But this can be difficult to maintain, especially if we&rsquo;re dealing with more than one author&rsquo;s posts. Wouldn&rsquo;t it be better not to make those unnecessary queries?</p>

<p>Well, it&rsquo;s possible! <code>:inverse_of</code> to the rescue.</p>

<pre><code class="ruby">class Author &lt; ActiveRecord::Base
  has_many :tweets, inverse_of: :author
end

class Tweet &lt; ActiveRecord::Base
  belongs_to :author, inverse_of: :tweets
end
</code></pre>

<p>Now when iterate over the tweets and reference the author, <strong>no additional queries
are needed</strong> because each tweet can now assign its author association from the
instance that exists already in memory:</p>

<pre><code class="ruby">author = Author.find(1)
# Author Load (0.3ms)  SELECT  &quot;authors&quot;.* FROM &quot;authors&quot; WHERE &quot;authors&quot;.&quot;id&quot; = $1 LIMIT 1  [[&quot;id&quot;, 1]]
#=&gt; #&lt;Author:0x007fc24c65c028 ... &gt;
author.tweets.map { |tw| tw.author.twitter_handle }
# Tweet Load (0.3ms)  SELECT &quot;posts&quot;.* FROM &quot;posts&quot; WHERE &quot;posts&quot;.&quot;type&quot; IN (&#39;Tweet&#39;) AND &quot;posts&quot;.&quot;author_id&quot; = $1  [[&quot;author_id&quot;, 1]]
=&gt; [&quot;vicenta&quot;, ... ]
</code></pre>

<p>Notice that additional queries for the author (<code>Author Load...</code>) don&rsquo;t appear in the query log: no more &ldquo;N+1&rdquo;!</p>

<p>You might be asking&hellip; why doesn&rsquo;t Rails just do this by default all the time? That&rsquo;s a good question. Turns out, it&rsquo;s not so easy. The <a href="http://guides.rubyonrails.org/association_basics.html#bi-directional-associations">Rails guides</a> say:</p>

<blockquote>
<p>Every association will attempt to automatically find the inverse association and set the <code>:inverse_of</code> option heuristically (based on the association name). Most associations with standard names will be supported.</p>
</blockquote>

<p>So Rails will &ldquo;try hard&rdquo; to make the inverse association work automatically to prevent the extra queries. If no name is found with the <code>:inverse_of</code> key in the association options, ActiveRecord will try to find the inverse association automatically inferring the class name from the association name, i.e. as <code>Post</code> is implied by <code>has_many :posts</code>.</p>

<p>To summarize, when the name of the association and the name of the class Rails expects to find in the
association don&rsquo;t match, or other certain other options are uses, automatic inverse lookup won&rsquo;t happen. Then you may see extra
queries for objects that already exist in memory.</p>

<h3>Avoid Uncertainty, Be Explicit</h3>

<p>Here&rsquo;s my recommendation:</p>

<p><strong>Set the <code>:inverse_of</code> option wherever you can.</strong></p>

<p>Yeah, Rails will try hard to do automatic inverses on your behalf, but <strong>leaving it up to Rails adds uncertainty</strong>. The uncertainty makes me uncomfortable.</p>

<p>Also know that <strong>other ActiveRecord options can interfere with automatic inverses</strong>: for example, using <code>:foreign_key</code> in your association will make it impossible to guess the inverse. In these cases, if you expect to have inverses set properly, using <code>:inverse_of</code> is necessary.</p>

<p>Here&rsquo;s an opportunity to reduce the chances that a name change or a Rails upgrade will introduce unexpected behavior to your application. I don&rsquo;t really want to write tests to be sure I&rsquo;m not unintentionally generating a &ldquo;N+1&rdquo; queries for my associations. I want to make it easier to introduce other changes into my app later.</p>

<p><strong>Beware of the gotchas</strong>: <code>:inverse_of</code> will only work with <code>has_many</code>, <code>has_one</code>, and <code>belong_to</code> associations and they will not work with the <code>:as</code>, <code>:polymorphic</code>, and <code>:through</code> options. <a href="http://guides.rubyonrails.org/association_basics.html#bi-directional-associations">Check out to the Rails docs on bi-directional associations</a> for more info.</p>

<p>Save yourself the trouble and set <code>:inverse_of</code> for valid <code>belongs_to</code>, <code>has_many</code>, and <code>has_one</code> associations.</p>


    </article>
    <hr />
    <section class="margin-bottom double">
      <p>
        If you liked this post, <a target="_blank" href="https://twitter.com/intent/tweet?text=Use%20inverse_of%20-%20rossta.net&amp;url=rossta.net%3A4567%2Fblog%2Fuse-inverse_of.html">share it on Twitter</a>
        and <a href="https://twitter.com/rossta">follow me</a>.
      </p>
      <p>
        Published on Dec  2, 2015
      </p>
    </section>
  </section>
  <section class="share margin-bottom double">
  </section>
  <section class="signup-form-standalone margin-bottom double">
    <!-- Begin MailChimp Signup Form -->
<div class="signup-form">
  <h3>Stop Wrangling with Rails</h3>
  <p>Sign up for my occasional newsletter on professional Ruby and Javascript for the web.</p>
  <div id="mc_embed_signup">
    <form action="//rossta.us6.list-manage.com/subscribe/post?u=8ce159842b5c98cecb4ebdf16&amp;id=96030b0bda" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
      <div id="mc_embed_signup_scroll">

        <div class="row">
          <div class="large-10 columns">
            <div class="row collapse">
              <div class="large-8 small-7 columns">
                <input type="email" placeholder="Your email..." value="" name="EMAIL" class="required email" id="mce-EMAIL">
              </div>
              <div class="large-4 small-5 columns">
                <input type="submit" value="Sign me up!" name="subscribe" id="mc-embedded-subscribe" class="button postfix">
              </div>
            </div>
          </div>
        </div>

        <div id="mce-responses" class="clear">
          <div class="response" id="mce-error-response" style="display:none"></div>
          <div class="response" id="mce-success-response" style="display:none"></div>
        </div>
        <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
        <div style="position: absolute; left: -5000px;"><input type="text" name="b_8ce159842b5c98cecb4ebdf16_96030b0bda" tabindex="-1" value=""></div>
      </div>
    </form>
  </div>

  <!--End mc_embed_signup-->
</div>

  </section>
    <hr />
    <section class="comments">
      <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname  = "rosskaff";
    var disqus_identifier = "use-inverse_of";
    var disqus_title      = "Use inverse_of";
    var disqus_url        = "https://rossta.net/blog/use-inverse_of.html";

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>

<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

<!-- <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a> -->

    </section>

      </section>
    </div>
    
    <div class="row">
      <footer>
        <section class="large-12 columns center-inline-list">
          <ul class="inline-list">
  <li><a href="mailto:ross@rossta.net">email</a></li>
  <li><a href="https://twitter.com/rossta">twitter</a></li>
  <li><a href="https://github.com/rossta">github</a></li>
  <li><a href="https://stackoverflow.com/users/771838/rossta?tab=profile">stackoverflow</a></li>
  <li><a href="https://www.linkedin.com/in/rosskaffenberger">linkedin</a></li>
</ul>

        </section>
      </footer>
    </div>
    <script src="/assets/javascripts/index.bundle-000158ba.js"></script>
    
    <script type="text/javascript">
!function(){var analytics=window.analytics=window.analytics||[];if(!analytics.initialize)if(analytics.invoked)window.console&&console.error&&console.error("Segment snippet included twice.");else{analytics.invoked=!0;analytics.methods=["trackSubmit","trackClick","trackLink","trackForm","pageview","identify","reset","group","track","ready","alias","page","once","off","on"];analytics.factory=function(t){return function(){var e=Array.prototype.slice.call(arguments);e.unshift(t);analytics.push(e);return analytics}};for(var t=0;t<analytics.methods.length;t++){var e=analytics.methods[t];analytics[e]=analytics.factory(e)}analytics.load=function(t){var e=document.createElement("script");e.type="text/javascript";e.async=!0;e.src=("https:"===document.location.protocol?"https://":"http://")+"cdn.segment.com/analytics.js/v1/"+t+"/analytics.min.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(e,n)};analytics.SNIPPET_VERSION="3.1.0";
analytics.load("NdBtrprkAGAjQryMShljRdVf90saElAU");
analytics.page()
window.$.tracking.flush(analytics);
}}();
</script>

  </body>
</html>
