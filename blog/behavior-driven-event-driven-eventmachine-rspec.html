<!doctype html>
<html class="antialiased">
  <head>
    <title>How to Test Your Eventmachine Code with RSpec - rossta.net</title>
<meta name="description" content="Ross Kaffenberger writes about software engineering, computer programming, and web development in Ruby, Javascript, and Elixir" />
<meta name="keywords" content="Ruby, RSpec" />
<meta name="site" content="rossta.net" />
<meta property="og:site_name" content="rossta.net" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:creator" content="Ross Kaffenberger" />
<meta name="twitter:description" content="Ross Kaffenberger writes about software engineering, computer programming, and web development in Ruby, Javascript, and Elixir" />
<meta name="twitter:image:src" content="https://rossta.net/assets/images/blog/stock/logs-pexels-photo.jpg" />
<meta name="twitter:title" content="How to Test Your Eventmachine Code with RSpec" />
<meta property="og:description" content="Ross Kaffenberger writes about software engineering, computer programming, and web development in Ruby, Javascript, and Elixir" />
<meta property="og:image" content="https://rossta.net/assets/images/blog/stock/logs-pexels-photo.jpg" />
<meta property="og:title" content="How to Test Your Eventmachine Code with RSpec" />
    <meta charset="utf-8" />
    <meta http-equiv='X-UA-Compatible' content='IE=edge;chrome=1' />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="mobile-web-app-capable" content="yes">

    <link rel="pingback" href="https://webmention.io/rossta.net/xmlrpc" />
    <link rel="webmention" href="https://webmention.io/rossta.net/webmention" />

    <link href='/assets/css/app.chunk.b98d856c2fc05a39cdaf.css' rel='stylesheet'></link>
  </head>
  <body id="application" class="leading-normal text-gray-900">
    <header id="welcome-nav" class="top-bar text-gray-800 sm:flex sm:justify-between sm:items-center sm:px-4 sm:py-3" data-topbar>
  <div class="flex justify-between items-center px-4 py-3 sm:p-0">
    <h1 class="text-2xl font-bold">
      <a class="logo" href="/"><span>rossta.net</span></a>
    </h1>
    <button type="button" class="top-bar-menu-button sm:hidden block text-gray-500 hover:text-gray-700 focus:text-gray-700 focus:outline-none">
      <svg class="h-6 w-6 fill-current" viewBox="0 0 24 24">
        <path class="icon" d="M4 5h16a1 1 0 0 1 0 2H4a1 1 0 1 1 0-2zm0 6h16a1 1 0 0 1 0 2H4a1 1 0 0 1 0-2zm0 6h16a1 1 0 0 1 0 2H4a1 1 0 0 1 0-2z"/>
        <path class="icon hidden" d="M18.278 16.864a1 1 0 0 1-1.414 1.414l-4.829-4.828-4.828 4.828a1 1 0 0 1-1.414-1.414l4.828-4.829-4.828-4.828a1 1 0 0 1 1.414-1.414l4.829 4.828 4.828-4.828a1 1 0 1 1 1.414 1.414l-4.828 4.829 4.828 4.828z"/>
      </svg>
    </button>
  </div>

  <nav class="top-bar-section hidden sm:block sm:flex sm:justify-around px-2 pt-2 pb-4">
    <a class="block px-2 py-1 hover:bg-green-200 sm:mt-0 sm:ml-2" href="/blog">blog</a>
    <a class="block px-2 py-1 hover:bg-green-200 sm:mt-0 sm:ml-2 mt-1" href="/series">series</a>
    <a class="block px-2 py-1 hover:bg-green-200 sm:mt-0 sm:ml-2 mt-1" href="/talks">talks</a>
    <a class="block px-2 py-1 hover:bg-green-200 sm:mt-0 sm:ml-2 mt-1" href="/projects">projects</a>
    <a class="block px-2 py-1 hover:bg-green-200 sm:mt-0 sm:ml-2 mt-1" href="/about">about</a>
    <a class="block px-2 py-1 hover:bg-green-200 sm:mt-0 sm:ml-2 mt-1" href="/feed.xml">feed</a>
  </nav>
</header>

    <main id="main" role="main" class="layout container">
        <article class="post mb-12">
    <header class="page-header mt-4">
  <h1>
    How to Test Your Eventmachine Code with RSpec
  </h1>
    <h2 class="mt-4 text-gray-600 font-medium">
      Test an eventmachine server-client socket connection with rspec
    </h2>
</header>

    <p>With all the hubbub around <a href="http://nodejs.org/">node.js</a> lately, it’s been easy to forget established event-driven server-side processing solutions in Ruby. One option is <a href="http://rubyeventmachine.com/">eventmachine</a>, which I recently used to develop a multi-player online sudoku game, <a href="http://playsudokill.com">Sudokill</a>, for my Heuristics class at NYU.</p>

<p>As the game designer, I needed to build a game server that could easily handle multiple socket connections to player programs written by my classmates. Leveraging the event-driven nature of eventmachine, I was able to build a server that is fast, efficient and easy to maintain.</p>

<p>A commonly-cited drawback to event-driven programming is that it’s hard. For starters, we can easily wrap our heads around a procedural approach to a server connecting to a client:</p>

<pre><code>Server waits for client 1
Client attempts to connect to server
Server accepts connection with client 1
Server tells client 1 to wait
Now server waits for client 2
Repeat as before and so on...
</code></pre>

<p>This pattern is familiar: like a cookbook recipe or instructions for building a model airplane, we are well-equpped to handle things one step at a time. With the event model, we think in terms of discrete behaviors instead of ordered steps. We need to identify important events and their responses:</p>

<pre><code>Whenever a socket connection is received, say hello
Whenever a message through a socket connection, process it
Whenever a socket connection disconnects, say goodbye
</code></pre>

<p>This model is common for front-end development (e.g. onclick, onmousever, etc.), but the notion of attaching events is not restricted to writing javascript for the DOM. Eventmachine provides some out-of-box hooks for adding behavior to expected events, like accepting socket connections. It also provides methods for defining and triggering our own custom behaviors.</p>

<p>Speaking of behavior: what about behavior-driven development with eventmachine? Absorbing the conceptual leap to programming to events is one challenge, and now, the mechanics of writing tests for them present another.</p>

<p>Let’s consider how we would test a client player connecting to my game server through a socket. I’ll build a class called Server which will be responsible for starting the eventmachine when its #start method is called. When a socket connection is made, I want to add the new player to a list of players kept on the server and send the message “READY” back to the client.</p>

<p>How would we write an integration test for this with rspec? The test would have to start an instance of my server class and separately initiate a client socket connection. Once the connection is made, then the test assertions can be run. After some digging around, I found some good examples to follow in the Ilya Grigorik’s eventmachine-backed websocket server, <a href="https://github.com/igrigorik/em-websocket">em-websocket</a>. Here’s the basic approach:</p>

<p>An eventmachine process runs in a loop: once we start the loop, it will run forever until we trigger the event to stop the loop. All of our eventmachine code will happen in the event loop. We setup the loop by passing our code in a block to the <a href="http://eventmachine.rubyforge.org/EventMachine.html#M000461">run</a> method:</p>

<p>So in our test, we’ll create the event loop with EM.run and pass a block with our test code in which we can start the game server and the socket connection. Once the assertions have been made, we’ll call EM.stop to end the event loop. Otherwise, it would run forever; we’d never get to the next test!</p>

<p>An eventmachine socket server can be initiated with the <a href="http://eventmachine.rubyforge.org/EventMachine.html#M000470">start_server</a> method. We’ll give this method a host and port where it will listen for clients.</p>

<p>We’ll also use eventmachine’s <a href="http://eventmachine.rubyforge.org/EventMachine.html#M000473">connect</a> method to make the client socket connection to the server. When a socket connection is made, eventmachine creates an instance of EventMachine::Connection which responds to certain methods representing different phases of the socket connection: after initialization, when a message is received, when the connection is broken, etc. EM.connect accepts a module or class inheriting from EventMachine::Connection which allows us to mix in our app or test logic to the connection.</p>

<p>To take the place of a player client in the test, I’ve borrowed FakeSocketClient (which subclasses EventMachine::Connection) from the em-websocket test suite and defined it in my spec_helper.rb. The fake client exposes attr_accessors onopen, omessage and onclose that we’ll treat like callbacks in the test.</p>

<p>We’ll assign a proc to the #onopen callback in FakeSocketClient. This proc will be triggered the first time the client socket receives a message. Since we want to the server to send a message when the connection is established, we expect this message to be “READY”. In addition, we’ll assert that there is one player added to the server’s list of players. Then we stop the event machine.</p>

<p>The key for making our rspec assertions: the socket connection between the server and client is accepted after the rest of the code in the EM.run block has been called. The instance FakeSocketClient receives #initialize and #post_init when EM.connect is called, but then the context returns to our test: we can now assign procs to FakeSocketClient’s onopen, onmessage and onclose callbacks as needed.</p>

<p>The #start method of our server is straightforward. It must start its own event loop and call EM.start_server previously discussed:</p>

<p>Other tests may include multiple client connections where we may need to assert that different messages like “YOUR TURN” and “WAIT YOUR TURN” are sent to the correct players.</p>

<p>For more reading on the subject of event programming, I recommend <a href="http://pdos.csail.mit.edu/~rtm/papers/dabek:event.pdf">Dabek, et.al, Event-driven Programming for Robust Software</a>.</p>

  </article>
  <section class="signup-form-standalone hero">
    <script src="https://f.convertkit.com/ckjs/ck.5.js" async></script>
<form
  action="https://app.convertkit.com/forms/818387/subscriptions?ref=Ruby"
  class="seva-form formkit-form"
  method="post"
  data-sv-form="818387"
  data-uid="cda82aafbf"
  data-format="inline"
  data-version="5"
  data-options="{&quot;settings&quot;:{&quot;after_subscribe&quot;:{&quot;action&quot;:&quot;message&quot;,&quot;success_message&quot;:&quot;Success! Now check your email to confirm your subscription.&quot;,&quot;redirect_url&quot;:&quot;&quot;},&quot;modal&quot;:{&quot;trigger&quot;:&quot;timer&quot;,&quot;scroll_percentage&quot;:null,&quot;timer&quot;:&quot;300&quot;,&quot;devices&quot;:null,&quot;show_once_every&quot;:&quot;7&quot;},&quot;recaptcha&quot;:{&quot;enabled&quot;:false},&quot;return_visitor&quot;:{&quot;action&quot;:&quot;show&quot;,&quot;custom_content&quot;:&quot;&quot;},&quot;slide_in&quot;:{&quot;display_in&quot;:null,&quot;trigger&quot;:null,&quot;scroll_percentage&quot;:null,&quot;timer&quot;:null,&quot;devices&quot;:null,&quot;show_once_every&quot;:null}}}"
>
  <div>
    <div class="mb-4">
        <h3 class="mb-2">
  Did you like this post?
</h3>
<p>
  Please
  <a href="https://twitter.com/intent/tweet?text=How%20to%20Test%20Your%20Eventmachine%20Code%20with%20RSpec&amp;url=https%3A%2F%2Frossta.net%2Fblog%2Fbehavior-driven-event-driven-eventmachine-rspec.html" target="_blank" rel="noopener">share it on Twitter</a>
  and enter your email below to subscribe to my newsletter on
  Ruby, RSpec, and the web. Thank you!
</p>

    </div>
    <ul class="formkit-alert formkit-alert-error" data-element="errors" data-group="alert"></ul>
    <div data-element="fields" data-stacked="false" class="seva-fields formkit-fields">
      <div class="formkit-field">
        <input
          class="formkit-input"
          name="email_address"
          placeholder="Your email address"
          required=""
          type="text"
          style="border-color: rgb(227, 227, 227); border-radius: 4px; color: rgb(0, 0, 0); font-weight: 400;"
        />
      </div>
      <button
        data-element="submit"
        class="formkit-submit button button-green"
      >
        <div class="formkit-spinner">
          <div></div>
          <div></div>
          <div></div>
        </div>
        <span>Subscribe</span>
      </button>
    </div>
    <a
      href="https://convertkit.com/?utm_source=dynamic&amp;utm_medium=referral&amp;utm_campaign=poweredby&amp;utm_content=form"
      class="formkit-powered-by"
      data-element="powered-by"
      target="_blank"
      rel="noopener noreferrer"
      >Powered By ConvertKit</a
    >
  </div>
  <style>
  </style>
    <input type="hidden" name="tags[]" value="733960" />
    <input type="hidden" name="tags[]" value="" />
  <input type="hidden" aria-label="URL" name="fields[url]" placeholder="URL" value="https://rossta.net/blog/2010-12-27-behavior-driven-event-driven-eventmachine-rspec.html" />
</form>


  </section>
  <article class="mb-12">
      <figure>
        <img src="/assets/images/blog/stock/logs-pexels-photo.jpg" alt="Logs pexels photo" />
      </figure>
  </article>
  <section class="mb-12 italic font-light">
    <p>
      Published on Dec 27, 2010
    </p>
  </section>

    </main>
    
    <footer class="bg-silver border-t text-xs">
  <div class="layout container p-6">
    <img src="/assets/images/turtle-logo.svg" class="turtle w-8 mb-6" alt="Turtle logo" />
    <section class="lg:flex lg:justify-between">
      <section class="mb-8">
        <h5 class="font-bold mb-4">Most Popular</h5>
        <ul>
            <li class="mb-1"><a href="/blog/building-a-pdf-viewer-with-vue-part-1.html">Rendering PDF pages with PDF.js and Vue</a></li>
            <li class="mb-1"><a href="/blog/from-sprockets-to-webpack.html">How we switched from Sprockets to Webpack</a></li>
            <li class="mb-1"><a href="/blog/how-to-specify-local-ruby-gems-in-your-gemfile.html">How to specify local Ruby gems in your Gemfile</a></li>
            <li class="mb-1"><a href="/blog/local-ssl-for-rails-5.html">Local SSL for Rails 5 development and tests</a></li>
            <li class="mb-1"><a href="/blog/using-the-web-push-api-with-vapid.html">Using Web Push Notifications with VAPID</a></li>
        </ul>
      </section>
      <section class="mb-8">
        <h5 class="font-bold mb-4">
          <a class="text-gray-900 hover:text-gray-700" href="blog/tags.html">
            Categories
          </a>
        </h5>
        <ul>
            <li class="mb-1"><a href="/blog/tags/ruby.html">Ruby</a></li>
            <li class="mb-1"><a href="/blog/tags/rails.html">Rails</a></li>
            <li class="mb-1"><a href="/blog/tags/javascript.html">JavaScript</a></li>
            <li class="mb-1"><a href="/blog/tags/vue.html">Vue</a></li>
            <li class="mb-1"><a href="/blog/tags/webpack.html">Webpack</a></li>
        </ul>
      </section>
      <section class="mb-8">
        <h5 class="font-bold mb-4">Contact</h5>
        <ul>
          <li class="mb-1"><a href="mailto:ross@rossta.net" rel="me noopener">email</a></li>
          <li class="mb-1"><a href="https://twitter.com/rossta" rel="me noopener">twitter</a></li>
          <li class="mb-1"><a href="https://medium.com/@rossta" rel="me noopener">medium</a></li>
          <li class="mb-1"><a href="https://github.com/rossta" rel="me noopener">github</a></li>
          <!-- <li class="mb-1"><a href="https://stackoverflow.com/users/771838/rossta?tab=profile" rel="me">stackoverflow</a></li> -->
          <li class="mb-1"><a href="https://www.linkedin.com/in/rosskaffenberger" rel="me noopener">linkedin</a></li>
        </ul>
      </section>
    </section>
    <p class="copyright text-center text-xs font-light">
      © 2019 Ross Kaffenberger. All rights reserved.
    </p>
  </div>
</footer>

    <script src='/assets/js/runtime.a975f6583411ef9e4ea1.js'></script><script src='/assets/js/vendors~app.chunk.6c6b7f30d28c87e9d1b2.js'></script><script src='/assets/js/app.chunk.40bf88435cbef0a86cb4.js'></script>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-16458563-2"></script>
<script type="text/javascript">
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-16458563-2');
</script>

  </body>
</html>
