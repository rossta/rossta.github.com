<!doctype html>
<html>
  <head>
    <title>Service Worker on Rails - rossta.net</title>
<meta name="description" content="This blog post describes how to integerate JavasScript for the new Service Worker API into Ruby and Rails applications that uuse Sprockets for the Rails asset pipeline." />
<meta name="keywords" content="Rails, JavaScript" />
<meta name="site" content="rossta.net" />
<meta property="og:site_name" content="rossta.net" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:creator" content="Ross Kaffenberger" />
<meta name="twitter:description" content="This blog post describes how to integerate JavasScript for the new Service Worker API into Ruby and Rails applications that uuse Sprockets for the Rails asset pipeline." />
<meta name="twitter:image:src" content="https://rossta.net/assets/images/blog/stock/blue-buildings-pexels-photo-bb3c8c6f.jpeg" />
<meta name="twitter:title" content="Service Worker on Rails" />
<meta property="og:description" content="This blog post describes how to integerate JavasScript for the new Service Worker API into Ruby and Rails applications that uuse Sprockets for the Rails asset pipeline." />
<meta property="og:image" content="https://rossta.net/assets/images/blog/stock/blue-buildings-pexels-photo-bb3c8c6f.jpeg" />
<meta property="og:title" content="Service Worker on Rails" />
    <meta charset="utf-8" />
    <meta http-equiv='X-UA-Compatible' content='IE=edge;chrome=1' />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="mobile-web-app-capable" content="yes">

    <link rel="manifest" href="/manifest.json" />
    <link rel="apple-touch-icon" sizes="57x57"   href="/touch-icon-57x57.png" />
    <link rel="apple-touch-icon" sizes="72x72"   href="/touch-icon-72x72.png" />
    <link rel="apple-touch-icon" sizes="120x120" href="/touch-icon-120x120.png" />
    <link rel="apple-touch-icon" sizes="152x152" href="/touch-icon-152x152.png" />
    <link rel="apple-touch-icon" sizes="167x167" href="/touch-icon-167x167.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/touch-icon-180x180.png" />
    <link rel="apple-touch-icon"                 href="/apple-touch-icon.png" />
    <link rel="icon"             sizes="192x192" href="/touch-icon-192x192.png" />
    <link rel="icon"             sizes="36x36"   href="/touch-icon-36x36.png" />
    <link rel="icon"             sizes="48x48"   href="/touch-icon-48x48.png" />
    <link rel="icon"             sizes="72x72"   href="/touch-icon-72x72.png" />
    <link rel="icon"             sizes="96x96"   href="/touch-icon-96x96.png" />
    <link rel="icon"             sizes="144x144" href="/touch-icon-144x144.png" />
    <link rel="icon"                             href="/touch-icon-192x192.png" />

    <script type="text/javascript" src="//use.typekit.net/ned0mml.js"></script>
    <script type="text/javascript">try{Typekit.load();}catch(e){}</script>
    <link href="/assets/stylesheets/index.bundle-09775923.css" rel="stylesheet" />
    <script src="/assets/javascripts/head.bundle-ae1a9d85.js"></script>
    <link href="/assets/images/turtle-favicon.ico" rel="icon" type="image/ico" />
    <script src="//load.sumome.com/" data-sumo-site-id="4e5296d0b3f078761e3d795e6e9b33b6d80a1a1de31de31018515c9916e38ad7" async="async"></script>

  </head>
  <body id="application" class="typekit">
    <nav id="welcome-nav" class="top-bar" data-topbar>
  <ul class="title-area">
    <li class="name">
      <h1><a class="logo" href="/"><img src="/assets/images/turtle-logo-096698b6.svg" /><span>rossta.net</span></a></h1>
    </li>
    <li class="toggle-topbar menu-icon"><a href="#">Menu</a></li>
  </ul>

  <section class="top-bar-section">
    <ul class="left">
      <li class="nav"><a href="/blog">blog</a></li>
      <li class="nav"><a href="/talks">talks</a></li>
      <li class="nav"><a href="/projects">projects</a></li>
      <li class="nav"><a href="/about">about</a></li>
      <li class="nav"><a href="/feed.xml">feed</a></li>
    </ul>
  </section>
</nav>

    <div class="row">
      <section id="main" role="main" class="large-12 small-12 columns">
          <section id="blog" class="margin-bottom double">
    <article class="post margin-bottom double">
      <header class="page-header with-summary">
  <h1>
    Service Worker on Rails
  </h1>
    <h3>
      Integrating Service Worker with the Rails asset pipeline
    </h3>
</header>

        <p><img src="/assets/images/blog/stock/blue-buildings-pexels-photo-bb3c8c6f.jpeg" /></p>

      <p>Have you heard about <a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API">Service
Worker</a>? I
believe this new JavaScript API has the potential to transform the way users
interact with the web and how web developers construct websites. Though still in
development, Service Worker is already <a href="https://jakearchibald.github.io/isserviceworkerready/">landing in modern
browsers</a>.</p>

<p>So far, there hasn&rsquo;t been a good story for adding Service Worker to Rails. Until
now!</p>

<p>There&rsquo;s a new Ruby gem, <a href="https://github.com/rossta/serviceworker-rails"><code>serviceworker-rails</code></a>, to make it easier to integrate Service Worker with the Rails asset pipeline. To understand why Rails developers might want to use this, let&rsquo;s take a step back.</p>

<h2>A brief intro</h2>

<p>In its plainest form, service workers are just JavaScript running in a separate thread outside the context of a web page, like any other <a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API">web worker</a>.</p>

<p>But, service workers are special; they can act as <strong>client-side proxies</strong>. This means they can <em>hook into the request/response cycle</em> on the user&rsquo;s machine.</p>

<p>Hooking in to the request/response cycle on the client-side means we can improve the user experience in ways that weren&rsquo;t possible (or much more difficult) previously. We could render HTML from a local cache while waiting for a response from the network or we could display another friendly page altogether when the network is offline. With service workers, we&rsquo;ll be able to pre-fetch and sync data in the background, push activity notifications to users and even let them know when new releases have been deployed.</p>

<p>I&rsquo;ve been <a href="/blog/adding-serviceworker-to-a-simple-website.html">playing with Service Worker</a> a bit lately. Now that you&rsquo;ve visited my site, your browser has cached the data for <a href="/offline.html">my offline page</a>, so if you lost your network connection, you&rsquo;d at least see a friendly message instead of the dreaded Chrome dinosaur.</p>

<p>Go ahead and take a look at the <a href="https://github.com/rossta/rossta.github.com/blob/45b67d326bb1118c9e0743ae74e1a5ca570a5947/source/assets/javascripts/serviceworker.js">source code for the rossta.net service worker</a> to see how I did it. I&rsquo;m still learning about Service Worker - is it <em>really</em> new after all - so I&rsquo;m sure there&rsquo;s lots of ways I could improve it!</p>

<h2>Let&rsquo;s talk Rails</h2>

<p>Next I wondered how I&rsquo;d add a Service Worker to a Rails application. I&rsquo;d expect Rails developers would want to be able to develop and deploy their service workers like any other JavaScript assets using the Rails asset pipeline. Not so fast though.</p>

<p>As it turns out, to use Service Workers on Rails, we want some, but not all, of the Rails asset pipeline.</p>

<p>The Rails asset pipeline makes a number of assumptions about what&rsquo;s best for deploying JavaScript, including asset digest fingerprints and long-lived cache headers - mostly to increase &ldquo;cacheability&rdquo;. Rails also assumes a single parent directory, <code>/public/assets</code>, to make it easier to look up the file path for a given asset.</p>

<p>Service worker assets must play by different rules. Consider these behaviors:</p>

<ul>
<li><p>Service workers may only be active from within the scope from which they are
served. So if you try to register a service worker from a Rails asset pipeline
path, like <code>/assets/serviceworker-abcd1234.js</code>, it will only be able to interact
with requests and responses within <code>/assets/</code><em>**</em>. This is not what we want.</p></li>
<li><p><a href="https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API#Download_install_and_activate">MDN states</a> browsers check for updated service worker scripts in the background every 24 hours (possibly less). Rails developers wouldn&rsquo;t be able to take advantage of this feature since the fingerprint strategy means assets at a given url are immutable. Beside fingerprintings, the <code>Cache-Control</code> headers used for static files served from Rails also work against browser&rsquo;s treatment of service workers.</p></li>
</ul>

<p><em>**</em><a href="https://slightlyoff.github.io/ServiceWorker/spec/service_worker/#service-worker-allowed">There is an early proposal</a> to use the <code>Service-Worker-Allowed</code> header to change scopes.</p>

<h2>What to do?</h2>

<p><a href="https://github.com/rails/sprockets/issues/44">For now</a>, Rails developers need to work around best practices in the Rails asset pipeline to use service workers.</p>

<p>One approach would be to just place service worker scripts in <code>/public</code>. That
could work, but it could mean foregoing the asset pipeline altogether. We lose
bundling, transpilation, testing and other features we do want. You could use
the pipeline but would then need to add steps to the build process to copy
precompiled service workers to the correct paths. In this case, you may want toaugment your
web server configuration to change <code>Cache-Control</code> headers for those selected service worker scripts - this may not be possible in certain environments.</p>

<p>Given the constraints around scoping, you could create
special controller actions to mount service workers at arbitrary routes. Rails
also gives you the ability to set custom headers on controller actions so that&rsquo;s
another benefit. From there, you either write your JavaScript in a template where you may lose the advantage of the asset pipeline or
expose the contents of a precompiled asset from within the controller.</p>

<p>I like this last option up until the point where a standard Rails controller
adds a lot of overhead, e.g. parameter parsing, session and cookie management, CSRF
protection, that isn&rsquo;t needed for serving static files. From there, you can drop
down to a <code>ActionController::Metal</code> subclass and figure out which extensions to
pull in&hellip; or put this in a Rack middleware!</p>

<h2>Using serviceworker-rails</h2>

<p>This is what I&rsquo;ve done with <a href="https://github.com/rossta/serviceworker-rails"><code>serviceworker-rails</code></a>. It inserts a middleware into the Rails stack that acts as a separate router for service worker scripts. In development, you can edit and recompile your service workers on the fly as with any other asset in the pipeline. In production, the service worker endpoints map to the precompiled asset in <code>/public/assets</code>.</p>

<p>Once the gem is added to your <code>Gemfile</code>, you can add a Rails initializer to set
up the service worker middleware router:</p>

<pre><code class="ruby"># config/initializers/serviceworker.rb
Rails.application.configure do
  config.serviceworker.routes.draw do
    match &quot;/serviceworker.js&quot; =&gt; &quot;path/to/precompiled/serviceworker&quot;
  end
end
</code></pre>

<p>By default, the middleware sets the <code>Cache-Control</code> header to avoid aggressive caching. It also gives you the ability to customize headers as desired.</p>

<pre><code class="ruby">match &quot;/serviceworker.js&quot; =&gt; &quot;app/serviceworker&quot;, headers: { &quot;X-Custom-Header&quot; =&gt; &quot;foobar&quot; }
</code></pre>

<p>Use globbing or named parameters in the service worker paths to interpolate
asset names.</p>

<pre><code class="ruby">match &quot;/*segments/serviceworker.js&quot; =&gt; &quot;%{segments}/serviceworker&quot;
match &quot;/project/:id/serviceworker.js&quot; =&gt; &quot;project/%{id}/serviceworker&quot;
</code></pre>

<p>Check out the project <a href="https://github.com/rossta/serviceworker-rails#serviceworkerrails">README</a> for more info on how to set up and configure the middleware for your Rails app.</p>

<p>Though the project is still young, you can see <code>serviceworker-rails</code> in action in the <a href="https://serviceworker-rails.herokuapp.com/">Service Workers on Rails Sandbox</a>. Inspired by Mozilla&rsquo;s <a href="https://serviceworke.rs/">Service Workers Cookbook</a>, it serves as good place to experiment with Service Workers on Rails in an open source setting. Try using the site in Chrome Canary with the <a href="https://www.chromium.org/blink/serviceworker/service-worker-faq">advanced service worker debugging tools</a> to play around. I&rsquo;ve added just a few examples so far but am interested to explore further with various caching strategies, push notifications, and eventually background sync to name a few.</p>

<p>What do you think of this approach?</p>

<hr>

<p>Interested in contributing? <a href="https://github.com/rossta/serviceworker-rails">Fork the serviceworker-rails gem</a> or the <a href="https://github.com/rossta/serviceworker-rails-sandbox">Service Workers on Rails Sandbox</a> to get started.</p>


    </article>
    <hr />
    <section class="margin-bottom double">
      <p>
        Did you like this post? Do me a favor: <a target="_blank" href="https://twitter.com/intent/tweet?text=Service%20Worker%20on%20Rails%20-%20rossta.net&amp;url=rossta.net%3A4567%2Fblog%2Fservice-worker-on-rails.html">share it on Twitter</a>,
          <a href="https://twitter.com/rossta">follow me - @rossta</a>,
          and sign up for my newsletter. Thanks!
        </p>
      </section>
    </section>
    <section class="signup-form-standalone margin-bottom double">
      <!-- Begin MailChimp Signup Form -->
<div class="signup-form">
  <h3>LEVEL UP your web development</h3>
  <p>Sign up for my occasional newsletter on professional Ruby and Javascript for the web.</p>
  <div id="mc_embed_signup">
    <form action="//rossta.us6.list-manage.com/subscribe/post?u=8ce159842b5c98cecb4ebdf16&amp;id=96030b0bda" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
      <div id="mc_embed_signup_scroll">

        <div class="row">
          <div class="large-10 columns">
            <div class="row collapse">
              <div class="large-8 small-7 columns">
                <input type="email" placeholder="Your email..." value="" name="EMAIL" class="required email" id="mce-EMAIL">
              </div>
              <div class="large-4 small-5 columns">
                <input type="submit" value="Sign me up!" name="subscribe" id="mc-embedded-subscribe" class="button postfix">
              </div>
            </div>
          </div>
        </div>

        <div id="mce-responses" class="clear">
          <div class="response" id="mce-error-response" style="display:none"></div>
          <div class="response" id="mce-success-response" style="display:none"></div>
        </div>
        <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
        <div style="position: absolute; left: -5000px;"><input type="text" name="b_8ce159842b5c98cecb4ebdf16_96030b0bda" tabindex="-1" value=""></div>
      </div>

      <input type="hidden" name="SIGNUP_LOCATION" id="signup_location" value="blog/2016-05-03-service-worker-on-rails.html" />
      <input type="hidden" name="SIGNUP_TAGS" id="signup_tags" value="Rails,JavaScript" />
    </form>
  </div>

  <!--End mc_embed_signup-->
</div>

    </section>
    <section class="margin-bottom double">
      <p>
          Part of the <a href="/blog/series/service-worker.html">Service Worker</a> series.
        Published on May  3, 2016
    </p>
  </section>
    <hr />
    <section class="comments">
      <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname  = "rosskaff";
    var disqus_identifier = "service-worker-on-rails";
    var disqus_title      = "Service Worker on Rails";
    var disqus_url        = "https://rossta.net/blog/service-worker-on-rails.html";

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>

<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

<!-- <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a> -->

    </section>

      </section>
    </div>
    
    <footer>
  <div class="row">
    <img class="turtle" src="/assets/images/turtle-logo-096698b6.svg" />
    <section class="large-6 columns">
      <h5>Most Popular</h5>
      <ul>
          <li><a href="/blog/whats-new-in-ruby-2-3-enumerable.html">What's new in Ruby 2.3 Enumerable</a></li>
          <li><a href="/blog/recurring-events-in-ruby.html">Recurring events in Ruby</a></li>
          <li><a href="/blog/how-to-write-a-simple-web-crawler-in-ruby-revisited.html">How to write a simple web crawler in Ruby - revisited</a></li>
          <li><a href="/blog/a-ruby-antihero-thread-pool.html">Thread Pool - A Ruby Antihero</a></li>
          <li><a href="/blog/how-to-specify-local-ruby-gems-in-your-gemfile.html">How to specify local Ruby gems in your Gemfile</a></li>
      </ul>
    </section>
    <section class="large-3 columns">
      <h5>Categories</h5>
      <ul>
          <li><a href="/blog/tags/ruby.html">Ruby</a></li>
          <li><a href="/blog/tags/rails.html">Rails</a></li>
          <li><a href="/blog/tags/javascript.html">JavaScript</a></li>
          <li><a href="/blog/tags/rspec.html">RSpec</a></li>
          <li><a href="/blog/tags/process.html">Process</a></li>
      </ul>
    </section>
    <section class="large-3 columns">
      <h5>Contact</h5>
      <ul>
        <li><a href="mailto:ross@rossta.net">email</a></li>
        <li><a href="https://twitter.com/rossta">twitter</a></li>
        <li><a href="https://github.com/rossta">github</a></li>
        <li><a href="https://stackoverflow.com/users/771838/rossta?tab=profile">stackoverflow</a></li>
        <li><a href="https://www.linkedin.com/in/rosskaffenberger">linkedin</a></li>
      </ul>
    </section>
  </div>
  <p class="copyright small subtle center">
    Â© 2016 Ross Kaffenberger. All rights reserved.
  </p>
</footer>

    <script src="/assets/javascripts/index.bundle-000158ba.js"></script>
    
    <script type="text/javascript">
!function(){var analytics=window.analytics=window.analytics||[];if(!analytics.initialize)if(analytics.invoked)window.console&&console.error&&console.error("Segment snippet included twice.");else{analytics.invoked=!0;analytics.methods=["trackSubmit","trackClick","trackLink","trackForm","pageview","identify","reset","group","track","ready","alias","page","once","off","on"];analytics.factory=function(t){return function(){var e=Array.prototype.slice.call(arguments);e.unshift(t);analytics.push(e);return analytics}};for(var t=0;t<analytics.methods.length;t++){var e=analytics.methods[t];analytics[e]=analytics.factory(e)}analytics.load=function(t){var e=document.createElement("script");e.type="text/javascript";e.async=!0;e.src=("https:"===document.location.protocol?"https://":"http://")+"cdn.segment.com/analytics.js/v1/"+t+"/analytics.min.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(e,n)};analytics.SNIPPET_VERSION="3.1.0";
analytics.load("NdBtrprkAGAjQryMShljRdVf90saElAU");
analytics.page()
window.$.tracking.flush(analytics);
}}();
</script>

  </body>
</html>
