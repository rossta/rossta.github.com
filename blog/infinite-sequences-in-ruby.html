<!doctype html>
<html>
  <head>
    <title>Infinite Sequences in Ruby - rossta.net</title>
<meta name="description" content="Wrap algorithms in Enumerable or Enumerator to have them behave like infinite collections." />
<meta name="keywords" content="Code, Ruby" />
<meta name="site" content="rossta.net" />
<meta property="og:site_name" content="rossta.net" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:creator" content="Ross Kaffenberger" />
<meta name="twitter:description" content="Wrap algorithms in Enumerable or Enumerator to have them behave like infinite collections." />
<meta name="twitter:image:src" content="https://rossta.net/assets/images/icon-ruby.png" />
<meta name="twitter:title" content="Infinite Sequences in Ruby" />
<meta property="og:description" content="Wrap algorithms in Enumerable or Enumerator to have them behave like infinite collections." />
<meta property="og:image" content="https://rossta.net/assets/images/icon-ruby.png" />
<meta property="og:title" content="Infinite Sequences in Ruby" />
    <meta charset="utf-8" />
    <meta http-equiv='X-UA-Compatible' content='IE=edge;chrome=1' />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <script type="text/javascript" src="//use.typekit.net/ned0mml.js"></script>
    <script type="text/javascript">try{Typekit.load();}catch(e){}</script>
    <link href="/assets/stylesheets/all.css?1449692192" rel="stylesheet" />
    <script src="/assets/javascripts/head.js?1449692192"></script>
    <link href="/assets/images/favicon.ico" rel="icon" type="image/ico" />
  </head>
  <body id="application" class="typekit">
    <nav id="welcome-nav" class="top-bar" data-topbar>
  <ul class="title-area">
    <li class="name">
      <h1><a class="logo" href="/">rossta.net</a></h1>
    </li>
    <li class="toggle-topbar menu-icon"><a href="#">Menu</a></li>
  </ul>

  <section class="top-bar-section">
    <ul class="left">
      <li class="nav"><a href="/blog">blog</a></li>
      <li class="nav"><a href="/about">about</a></li>
      <li class="nav"><a href="/projects">projects</a></li>
      <li class="nav"><a href="/feed.xml">feed</a></li>
    </ul>
  </section>
</nav>

    <div class="row">
      <section id="main" role="main" class="large-12 small-12 columns">
          <section id="blog" class="margin-bottom double">
    <article class="post margin-bottom double">
      <header>
  <h2>
    Infinite Sequences in Ruby
      <br />
      <small>Treat your algorithms like enumerables with Enumerator</small>
  </h2>
</header>


      <p>Functional languages like Clojure have <a href="http://clojure.org/sequences">sequences</a>. Sequences are pretty amazing: they let us treat algorithms as data structures. We can call functions on the data as it is produced, allowing us to interact with the results like a collection even when the sequence is infinite.</p>

<p>The Ruby standard library doesn’t have an official sequence class or module, but we can get pretty far with the <code>Enumerable</code> module. Rubyists are typically introduced to <code>Enumerable</code> through methods on <code>Array</code>,  like <code>#map</code> and <code>#select</code>. Arrays like <code>[1,2,3,4]</code> may be thought of as finite, eagerly loaded sequences; they already contains all the members we want to enumerate with methods. We can also extend this API to sequences like “give me multiples of 5” in Ruby.</p>

<h3>Enumerable Fibonacci</h3>

<p>Consider an infinite sequence like fibonacci. We could create a method that generates the first <code>n</code> fibonacci members given <code>n</code> as a paramter. This implementation could look like this:</p>

<pre><code class="ruby">def eager_fibonacci(n)
  a = b = 1
  result = []

  loop do
    break if result.size &gt;= n

    result &lt;&lt; a
    a, b = b, a + b
  end

  result
end
</code></pre>

<p>This works, but we can go one step further. Instead of returning an eagerly-loaded array, we can return an <code>Enumerator</code>. We&rsquo;ll yield each member to the <code>Enumerator</code> as it is generated.</p>

<pre><code class="ruby">def fibonacci
  Enumerator.new do |y|
    a = b = 1

    loop do
      y &lt;&lt; a
      a, b = b, a + b
    end
  end
end
</code></pre>

<p>What the heck is an <code>Enumerator</code>? It’s an enumerable object that can be used for either internal or external enumeration of a collection - for more details, check out my <a href="https://rossta.net/blog/what-is-enumerator.html">previous post</a>. The <code>Enumerator</code> initialize method take a block that acts like a template for an enumerable algorithm. The block takes a parameter, <code>y</code>, which is an instance of an <code>Enumerator::Yielder</code>, which let&rsquo;s us yield each member of the <code>Enumerator</code> to blocks passed to <code>Enumerable</code> method calls. In short, this means we can treat an <code>Enumerator</code> like an <code>Array</code>, though we can also do so much more.</p>

<p>To retrieve the first ten members of our enumerable fibonacci method, we’d instead do something like:</p>

<pre><code class="ruby">fibonacci.take(10)
</code></pre>

<p>We can still enumerate over the fibonacci sequence as before:</p>

<pre><code class="ruby">fibonacci.take(10).each { |i| puts i }
</code></pre>

<p>Using the <code>Enumerator#lazy</code> method, we can avoid eager enumeration and run queries or calculations as each member is generated. This opens the door to some interesting use cases, like the following:</p>

<pre><code class="ruby">fibonacci.lazy.select(&amp;:even?).first(10)
#=&gt; [2, 8, 34, 144, 610, 2584, 10946, 46368, 196418, 832040]

fibonacci.lazy.select(&amp;:odd?).first(10)
#=&gt; [1, 1, 3, 5, 13, 21, 55, 89, 233, 377]
</code></pre>

<p>We can filter for the first 10 even or odd numbers generated by fibonacci. Inserting the <code>with_index</code> enumerator method, we can see how many items we need to enumerate to get either the first 10 even or odd numbers:</p>

<pre><code class="ruby">fibonacci.lazy.with_index.select { |n, i| n.odd? }.first(10)
#=&gt; [[1, 0], [1, 1], [3, 3], [5, 4], [13, 6], [21, 7], [55, 9], [89, 10], [233, 12], [377, 13]]

fibonacci.lazy.with_index.select { |n, i| n.even? }.first(10)
#=&gt; [[2, 2], [8, 5], [34, 8], [144, 11], [610, 14], [2584, 17], [10946, 20], [46368, 23], [196418, 26], [832040, 29]]
</code></pre>

<p>Notice we only need to enumerate 13 items to retrieve 10 odd numbers from fibonacci, while 29 are needed to retrieve the first 10 evens. These results wouldn’t be easily achieved with our previous fibonacci implementation in which the number of desired members must be known ahead of time.</p>

<p>Try creating other numerical sequences with enumerators on your own, like multiples of <code>n</code>, factorials for the first <code>n</code> integers or enumerating sums of squares. Also be sure to check out Pat Shaughnessy&rsquo;s <a href="http://patshaughnessy.net/2013/4/3/ruby-2-0-works-hard-so-you-can-be-lazy">great primer on lazy enumerators</a>.</p>

<h3>Sequence Functions</h3>

<p>Clojure also has a number of useful functions that allow us to generate sequences from other functions. Let’s look at <code>repeatedly</code> which simply calls the given function over and over, emitting the results as a sequence. To get a sequence of five random numbers between 0 - 100:</p>

<pre><code class="clojure">(take 5 (repeatedly #(rand-int 100)))
</code></pre>

<p>For those new to Clojure, the syntax may look odd, but this expression &ldquo;takes the first 5 results of repeatedly asking for a random integer of 0 to 100&rdquo; and returns a sequence.</p>

<p>We can use Ruby enumerators to do something similar in Ruby. Let’s create our own version of <code>repeatedly</code>, which takes a will call a given block over and over again. Let&rsquo;s start with a naive implementation which use a loop:</p>

<pre><code class="ruby">def repeatedly_foo(&amp;block)
 loop do
    block.call
  end
end
</code></pre>

<p>This method is not useful because the function will never return; it&rsquo;s an infinite loop! You’ll have to issue a kill signal to stop the execution (Ctrl-C!). We could give <code>repeatedly_foo</code> a limit <code>n</code> and break out of the loop with a counter.</p>

<pre><code class="ruby">def repeatedly_foo(n, &amp;block)
  result = []

  loop do
    break if result.size &gt;= n

    result &lt;&lt; block.call
  end

  result
end
</code></pre>

<p>This is an improvement, but like our fibonacci example earlier, it means we need to load the desired number eagerly in the <code>result</code> array and have less control over the results.</p>

<p>Again, we&rsquo;ll wrap the loop in an <code>Enumerator</code> so we can treat the result as a sequence. We’ll “yield” the result of calling the block to the <code>Enumerator::Yielder</code> object (the <code>y &lt;&lt; block.call</code>) expression in our loop:</p>

<pre><code class="ruby">def repeatedly(&amp;block)
  Enumerator.new do |y|
    loop do
      y &lt;&lt; block.call # &quot;yield&quot; the result to the Enumerator::Yielder
    end
  end
end
</code></pre>

<p>We now have an abstraction that can be chained to other enumerator methods. It also has a similar terse feel to the Clojure inspiration we saw earlier.</p>

<pre><code class="ruby">repeatedly { rand(100) }.take(5)
#=&gt; [48, 48, 72, 41, 70] # your results will vary... they&#39;re random!
</code></pre>

<h3>To Infinity and Beyond</h3>

<p>Of course, sequences of numbers aren&rsquo;t the only concept that can be modeled this way in Ruby. Any collection of unknown size, for example, results from a search query, paginated resources from an API client library, data from a web crawl, etc., are also great use cases for exposure as enumerables. Consider wrapping your generated collections in an Enumerator to provide callers with flexible, composable results.</p>


    </article>
    <hr />
    <section class="margin-bottom double">
      <p>
          This post is part of the <a href="/blog/series/enumerable.html">Enumerable</a> series.
        Published on Nov 21, 2015
      </p>
      <a href="https://twitter.com/share"
  class="twitter-share-button"{count}
  data-via="rossta"
  data-size="large">Tweet</a>

      <a href="https://twitter.com/rossta"
  class="twitter-follow-button"
  data-show-count="false"
  data-size="large"
  >Follow @rossta</a>

    </section>
  </section>
  <section class="share margin-bottom double">
  </section>
  <section class="signup-form standalone margin-bottom double">
    <!-- Begin MailChimp Signup Form -->
<div class="signup-form">
  <h3>Stop Wrangling with Rails</h3>
  <p>Sign up for my occasional newsletter on professional Ruby and Javascript for the web.</p>
  <div id="mc_embed_signup">
    <form action="//rossta.us6.list-manage.com/subscribe/post?u=8ce159842b5c98cecb4ebdf16&amp;id=96030b0bda" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
      <div id="mc_embed_signup_scroll">

        <div class="row">
          <div class="large-10 columns">
            <div class="row collapse">
              <div class="large-8 small-7 columns">
                <input type="email" placeholder="Your email..." value="" name="EMAIL" class="required email" id="mce-EMAIL">
              </div>
              <div class="large-4 small-5 columns">
                <input type="submit" value="Sign me up!" name="subscribe" id="mc-embedded-subscribe" class="button postfix">
              </div>
            </div>
          </div>
        </div>

        <div id="mce-responses" class="clear">
          <div class="response" id="mce-error-response" style="display:none"></div>
          <div class="response" id="mce-success-response" style="display:none"></div>
        </div>
        <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
        <div style="position: absolute; left: -5000px;"><input type="text" name="b_8ce159842b5c98cecb4ebdf16_96030b0bda" tabindex="-1" value=""></div>
      </div>
    </form>
  </div>

  <!--End mc_embed_signup-->
</div>

  </section>
    <hr />
    <section class="comments">
      <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname  = "rosskaff";
    var disqus_identifier = "infinite-sequences-in-ruby";
    var disqus_title      = "Infinite Sequences in Ruby";
    var disqus_url        = "https://rossta.net/blog/infinite-sequences-in-ruby.html";

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>

<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

<!-- <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a> -->

    </section>

      </section>
    </div>
    
    <div class="row">
      <footer>
        <section class="large-12 columns center-inline-list">
          <ul class="inline-list">
  <li><a href="mailto:ross@rossta.net">email</a></li>
  <li><a href="https://twitter.com/rossta">twitter</a></li>
  <li><a href="https://github.com/rossta">github</a></li>
  <li><a href="https://stackoverflow.com/users/771838/rossta?tab=profile">stackoverflow</a></li>
  <li><a href="https://www.linkedin.com/pub/ross-kaffenberger/4/675/5b9">linkedin</a></li>
</ul>

        </section>
      </footer>
    </div>
    <script src="/assets/javascripts/all.js?1449692192"></script>
      <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
  <script>
    !function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");
  </script>

    <script type="text/javascript">
!function(){var analytics=window.analytics=window.analytics||[];if(!analytics.initialize)if(analytics.invoked)window.console&&console.error&&console.error("Segment snippet included twice.");else{analytics.invoked=!0;analytics.methods=["trackSubmit","trackClick","trackLink","trackForm","pageview","identify","reset","group","track","ready","alias","page","once","off","on"];analytics.factory=function(t){return function(){var e=Array.prototype.slice.call(arguments);e.unshift(t);analytics.push(e);return analytics}};for(var t=0;t<analytics.methods.length;t++){var e=analytics.methods[t];analytics[e]=analytics.factory(e)}analytics.load=function(t){var e=document.createElement("script");e.type="text/javascript";e.async=!0;e.src=("https:"===document.location.protocol?"https://":"http://")+"cdn.segment.com/analytics.js/v1/"+t+"/analytics.min.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(e,n)};analytics.SNIPPET_VERSION="3.1.0";
analytics.load("NdBtrprkAGAjQryMShljRdVf90saElAU");
analytics.page()
}}();
</script>

  </body>
</html>
