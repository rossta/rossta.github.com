define(["./core","./var/slice","./callbacks"],function(e,n){return e.extend({Deferred:function(n){var r=[["resolve","done",e.Callbacks("once memory"),"resolved"],["reject","fail",e.Callbacks("once memory"),"rejected"],["notify","progress",e.Callbacks("memory")]],t="pending",i={state:function(){return t},always:function(){return o.done(arguments).fail(arguments),this},then:function(){var n=arguments;return e.Deferred(function(t){e.each(r,function(r,s){var a=e.isFunction(n[r])&&n[r];o[s[1]](function(){var n=a&&a.apply(this,arguments);n&&e.isFunction(n.promise)?n.promise().done(t.resolve).fail(t.reject).progress(t.notify):t[s[0]+"With"](this===i?t.promise():this,a?[n]:arguments)})}),n=null}).promise()},promise:function(n){return null!=n?e.extend(n,i):i}},o={};return i.pipe=i.then,e.each(r,function(e,n){var s=n[2],a=n[3];i[n[1]]=s.add,a&&s.add(function(){t=a},r[1^e][2].disable,r[2][2].lock),o[n[0]]=function(){return o[n[0]+"With"](this===o?i:this,arguments),this},o[n[0]+"With"]=s.fireWith}),i.promise(o),n&&n.call(o,o),o},when:function(r){var t,i,o,s=0,a=n.call(arguments),u=a.length,c=1!==u||r&&e.isFunction(r.promise)?u:0,l=1===c?r:e.Deferred(),f=function(e,r,i){return function(o){r[e]=this,i[e]=arguments.length>1?n.call(arguments):o,i===t?l.notifyWith(r,i):--c||l.resolveWith(r,i)}};if(u>1)for(t=new Array(u),i=new Array(u),o=new Array(u);u>s;s++)a[s]&&e.isFunction(a[s].promise)?a[s].promise().done(f(s,o,a)).fail(l.reject).progress(f(s,i,t)):--c;return c||l.resolveWith(o,a),l.promise()}}),e});